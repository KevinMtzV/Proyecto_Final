{% extends 'base.html' %}
{% load humanize %}


{% block title %}Mi Dashboard{% endblock %}

{% block content %}
<h1 class="mb-4">Mi Perfil</h1>

<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-dark">
                <h4 class="mb-0">Datos del Usuario</h4>
            </div>
            <div class="card-body row g-3 align-items-center">
                <div class="col-md-4">
                    <p class="mb-1"><strong>Usuario:</strong> {{ user.username }}</p>
                    <p class="mb-1"><strong>Email:</strong> {{ user.email|default:'—' }}</p>
                </div>
                <div class="col-md-4">
                    <p class="mb-1"><strong>Fecha de registro:</strong> {{ user.date_joined|date:"d M, Y H:i" }}</p>
                    <p class="mb-1"><strong>Último inicio de sesión:</strong> {{ user.last_login|date:"d M, Y H:i"|default:'—' }}</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a class="btn btn-outline-primary me-2" href="{% url 'cambiar_contrasena' %}">Cambiar contraseña</a>
                    
                </div>
            </div>
            <div class="card-footer bg-light">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="fw-bold">Campañas organizadas</div>
                        <div class="display-6">{{ total_campanas }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="fw-bold">Total donado</div>
                        <div class="display-6">${{ total_donado|floatformat:2|intcomma }}</div>
                    </div>
                    <div class="col-md-4">
                        <div class="fw-bold">Última donación</div>
                        <div>
                            {% if ultima_donacion %}
                                <span class="badge bg-success">{{ ultima_donacion.get_tipo_display }}</span>
                                <small class="text-muted ms-2">{{ ultima_donacion.fecha_donacion|date:"d M, Y" }}</small>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>

<div class="row">
<div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Mis Donaciones ({{ mis_donaciones.count }})</h4>
            </div>
            <ul class="list-group list-group-flush">
                {% for donacion in mis_donaciones|slice:":5" %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        Donaste ${{ donacion.monto|floatformat:2}} a la campaña <span class="fw-bold">"{{ donacion.campana.titulo|truncatechars:20 }}"</span>
                    </div>
                    <small class="text-muted">{{ donacion.fecha_donacion|date:"d M, Y" }}</small>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">Aún no has realizado ninguna donación.</li>
                {% endfor %}
            </ul>
            <div class="card-footer text-center">
                <!-- <a href="{% url 'campana_listado' %}" class="btn btn-sm btn-primary me-2">Buscar Campañas</a> -->
                <button id="btn-cargar-donaciones" class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#panel-todas-donaciones" aria-expanded="false" aria-controls="panel-todas-donaciones">
                    Ver todas mis donaciones
                </button>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Mis Campañas Organizadas</h4>
            </div>
            <ul class="list-group list-group-flush">
                {% for campana in mis_campanas|slice:":5" %}
                <li class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <a href="{% url 'campana_detalle' campana.pk %}">{{ campana.titulo }}</a>
                        </div>
                        <span class="badge bg-{{ campana.estado|lower|yesno:'success,warning'|default:'secondary' }}">
                            {{ campana.get_estado_display }}
                        </span>
                    </div>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'campana_editar' campana.pk %}" class="btn btn-outline-secondary">
                            <i class="bi bi-pencil"></i> Editar
                        </a>
                        <button type="button" class="btn btn-outline-warning" 
                                onclick="cambiarEstadoCampana({{ campana.pk }}, '{{ campana.estado }}')">
                            <i class="bi bi-arrows-angle-contract"></i> Cambiar Estado
                        </button>
                        <button type="button" class="btn btn-outline-danger" 
                                onclick="eliminarCampana({{ campana.pk }}, '{{ campana.titulo|escapejs }}')">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </div>
                </li>
                {% empty %}
                <li class="list-group-item text-muted">Aún no has creado ninguna campaña.</li>
                {% endfor %}
            </ul>
            <div class="card-footer text-center">
                <a href="{% url 'campana_crear' %}" class="btn btn-sm btn-success">Crear Nueva Campaña</a>
            </div>
        </div>
    </div>
    
    
</div>

    <!-- Panel colapsable: Todas las donaciones del usuario (se carga por AJAX) -->
<div class="row">
    <div class="col-lg-12">
        <div id="panel-todas-donaciones" class="collapse">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Todas mis donaciones</h5>
                </div>
                <div class="card-body">
                    <div id="donaciones-spinner" class="text-center my-3" style="display:none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                    <div id="donaciones-error" class="alert alert-danger d-none" role="alert"></div>
                    <ul id="lista-todas-donaciones" class="list-group list-group-flush"></ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Cambiar Estado de Campaña -->
<div class="modal fade" id="modalCambiarEstado" tabindex="-1" aria-labelledby="modalCambiarEstadoLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCambiarEstadoLabel">Cambiar Estado de Campaña</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Estado actual: <strong id="estadoActualText"></strong></p>
                <div class="mb-3">
                    <label for="nuevoEstadoSelect" class="form-label">Selecciona el nuevo estado:</label>
                    <select class="form-select" id="nuevoEstadoSelect">
                        <option value="ACT">Activa</option>
                        <option value="COM">Completada</option>
                        <option value="CAN">Cancelada</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnConfirmarCambioEstado">Guardar Cambio</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Confirmar Eliminación -->
<div class="modal fade" id="modalEliminarCampana" tabindex="-1" aria-labelledby="modalEliminarCampanaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalEliminarCampanaLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de eliminar la campaña <strong id="campanaTituloEliminar"></strong>?</p>
                <p class="text-danger"><i class="bi bi-exclamation-triangle"></i> Esta acción no se puede deshacer y solo funcionará si la campaña no tiene donaciones.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar Campaña</button>
            </div>
        </div>
    </div>
</div><script>
    (function() {
        const collapseEl = document.getElementById('panel-todas-donaciones');
        const btn = document.getElementById('btn-cargar-donaciones');
        const listEl = document.getElementById('lista-todas-donaciones');
        const spinnerEl = document.getElementById('donaciones-spinner');
        const errorEl = document.getElementById('donaciones-error');
        let loaded = false;

        async function fetchMisDonaciones() {
            spinnerEl.style.display = 'block';
            errorEl.classList.add('d-none');
            listEl.innerHTML = '';
            try {
                const resp = await fetch('/api/v1/donaciones/mis-donaciones/');
                if (!resp.ok) {
                    throw new Error('Error HTTP ' + resp.status);
                }
                const data = await resp.json();
                if (!Array.isArray(data) || data.length === 0) {
                    listEl.innerHTML = '<li class="list-group-item text-muted">No tienes donaciones registradas todavía.</li>';
                    return;
                }
                const rows = data.map(d => {
                    const esMon = d.tipo === 'MON';
                    const valor = esMon ? (d.monto ? ('$' + Number(d.monto).toFixed(2)) : '$0.00') : (d.articulo_donado || 'Artículo');
                    const valorClass = esMon ? 'text-success' : 'text-primary';
                    const fecha = d.fecha_donacion ? new Date(d.fecha_donacion).toLocaleDateString('es-ES') : '';
                    const campana = d.campana_titulo || '—';
                    return `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                Donaste <span class="fw-bold ${valorClass}">${valor}</span> a <span class="fw-bold">"${campana}"</span>
                            </div>
                            <small class="text-muted">${fecha}</small>
                        </li>`;
                });
                listEl.innerHTML = rows.join('');
            } catch (err) {
                errorEl.textContent = 'No se pudieron cargar tus donaciones. Intenta nuevamente.';
                errorEl.classList.remove('d-none');
            } finally {
                spinnerEl.style.display = 'none';
            }
        }

        // Cargar al expandir por primera vez
        collapseEl.addEventListener('show.bs.collapse', async () => {
            if (!loaded) {
                await fetchMisDonaciones();
                loaded = true;
            }
        });
    })();

    // ====== FUNCIONES PARA OPERACIONES API EN CAMPAÑAS ======
    
    // Obtener token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Variables globales para los modals
    let campanaIdActual = null;
    let campanaTituloActual = null;
    const estados = {
        'ACT': 'Activa',
        'COM': 'Completada',
        'CAN': 'Cancelada'
    };

    // PATCH: Cambiar estado de campaña
    function cambiarEstadoCampana(campanaId, estadoActual) {
        campanaIdActual = campanaId;
        
        // Configurar modal
        document.getElementById('estadoActualText').textContent = estados[estadoActual];
        
        // Configurar select, excluir estado actual
        const selectEstado = document.getElementById('nuevoEstadoSelect');
        selectEstado.innerHTML = '';
        for (const [codigo, nombre] of Object.entries(estados)) {
            if (codigo !== estadoActual) {
                const option = document.createElement('option');
                option.value = codigo;
                option.textContent = nombre;
                selectEstado.appendChild(option);
            }
        }
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalCambiarEstado'));
        modal.show();
    }

    // Confirmar cambio de estado
    document.getElementById('btnConfirmarCambioEstado').addEventListener('click', async function() {
        const nuevoEstado = document.getElementById('nuevoEstadoSelect').value;
        
        try {
            const response = await fetch(`/api/v1/campanas/${campanaIdActual}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    estado: nuevoEstado
                })
            });

            if (response.ok) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalCambiarEstado'));
                modal.hide();
                showToast('Éxito', 'Estado actualizado exitosamente', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const error = await response.json();
                showToast('Error', error.detail || 'No se pudo actualizar el estado', 'error');
            }
        } catch (err) {
            showToast('Error', 'Error de conexión: ' + err.message, 'error');
        }
    });

    // DELETE: Eliminar campaña
    function eliminarCampana(campanaId, titulo) {
        campanaIdActual = campanaId;
        campanaTituloActual = titulo;
        
        // Configurar modal
        document.getElementById('campanaTituloEliminar').textContent = titulo;
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalEliminarCampana'));
        modal.show();
    }

    // Confirmar eliminación
    document.getElementById('btnConfirmarEliminar').addEventListener('click', async function() {
        try {
            const response = await fetch(`/api/v1/campanas/${campanaIdActual}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });

            if (response.ok || response.status === 204) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEliminarCampana'));
                modal.hide();
                showToast('Éxito', 'Campaña eliminada exitosamente', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEliminarCampana'));
                modal.hide();
                const error = await response.json();
                showToast('Error', error.detail || 'No se pudo eliminar la campaña', 'error');
            }
        } catch (err) {
            showToast('Error', 'Error de conexión: ' + err.message, 'error');
        }
    });
</script>
{% endblock %}